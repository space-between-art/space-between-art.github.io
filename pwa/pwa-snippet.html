<!--
========================================
å¿ƒéˆç™‚ç™’å­¸é™¢ - PWA ä»£ç¢¼ç‰‡æ®µ
å°‡ä»¥ä¸‹ä»£ç¢¼åŠ å…¥æ‰€æœ‰ HTML é é¢çš„ <head> å€åŸŸ
========================================
-->

<!-- PWA Meta æ¨™ç±¤ -->
<meta name="theme-color" content="#B87333">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ç™‚ç™’å­¸é™¢">
<meta name="mobile-web-app-capable" content="yes">
<meta name="application-name" content="ç™‚ç™’å­¸é™¢">
<meta name="msapplication-TileColor" content="#0d1117">
<meta name="msapplication-config" content="/browserconfig.xml">

<!-- PWA Manifest -->
<link rel="manifest" href="/manifest.json">

<!-- App Icons -->
<link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
<link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#B87333">

<!-- iOS Splash Screens (å¯é¸ï¼Œæå‡å•Ÿå‹•é«”é©—) -->
<link rel="apple-touch-startup-image" href="/splash/splash-640x1136.png" media="(device-width: 320px) and (device-height: 568px)">
<link rel="apple-touch-startup-image" href="/splash/splash-750x1334.png" media="(device-width: 375px) and (device-height: 667px)">
<link rel="apple-touch-startup-image" href="/splash/splash-1242x2208.png" media="(device-width: 414px) and (device-height: 736px)">
<link rel="apple-touch-startup-image" href="/splash/splash-1125x2436.png" media="(device-width: 375px) and (device-height: 812px)">
<link rel="apple-touch-startup-image" href="/splash/splash-1242x2688.png" media="(device-width: 414px) and (device-height: 896px)">

<!--
========================================
å°‡ä»¥ä¸‹ JavaScript åŠ å…¥ </body> ä¹‹å‰
========================================
-->

<script>
// ========== Service Worker è¨»å†Š ==========
if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
        try {
            const registration = await navigator.serviceWorker.register('/service-worker.js');
            console.log('âœ… Service Worker è¨»å†ŠæˆåŠŸ:', registration.scope);
        } catch (error) {
            console.error('âŒ Service Worker è¨»å†Šå¤±æ•—:', error);
        }
    });
}

// ========== PWA å®‰è£æç¤º ==========
let deferredPrompt;
const installBanner = document.getElementById('pwa-install-banner');

window.addEventListener('beforeinstallprompt', (e) => {
    // é˜»æ­¢ç€è¦½å™¨é è¨­çš„å®‰è£æç¤º
    e.preventDefault();
    deferredPrompt = e;
    
    // é¡¯ç¤ºè‡ªå®šç¾©å®‰è£æ©«å¹…
    if (installBanner) {
        installBanner.style.display = 'flex';
    }
    
    console.log('ğŸ“± PWA å¯å®‰è£');
});

// å®‰è£æŒ‰éˆ•é»æ“Šè™•ç†
function installPWA() {
    if (!deferredPrompt) return;
    
    // é¡¯ç¤ºå®‰è£æç¤º
    deferredPrompt.prompt();
    
    deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
            console.log('âœ… ç”¨æˆ¶æ¥å—å®‰è£');
            if (installBanner) {
                installBanner.style.display = 'none';
            }
        } else {
            console.log('âŒ ç”¨æˆ¶æ‹’çµ•å®‰è£');
        }
        deferredPrompt = null;
    });
}

// é—œé–‰å®‰è£æ©«å¹…
function dismissInstallBanner() {
    if (installBanner) {
        installBanner.style.display = 'none';
    }
    // è¨˜ä½ç”¨æˆ¶é¸æ“‡ï¼Œ24å°æ™‚å…§ä¸å†é¡¯ç¤º
    localStorage.setItem('pwa-install-dismissed', Date.now());
}

// ç›£è½å®‰è£å®Œæˆ
window.addEventListener('appinstalled', () => {
    console.log('ğŸ‰ PWA å®‰è£å®Œæˆ');
    if (installBanner) {
        installBanner.style.display = 'none';
    }
    deferredPrompt = null;
});

// ========== iOS å®‰è£æŒ‡å—ï¼ˆiOS ä¸æ”¯æ´ beforeinstallpromptï¼‰==========
function isIOS() {
    return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
}

function isInStandaloneMode() {
    return window.matchMedia('(display-mode: standalone)').matches || 
           window.navigator.standalone === true;
}

// å¦‚æœæ˜¯ iOS ä¸”ä¸åœ¨ standalone æ¨¡å¼ï¼Œé¡¯ç¤ºå®‰è£æŒ‡å—
if (isIOS() && !isInStandaloneMode()) {
    const iosGuide = document.getElementById('ios-install-guide');
    const dismissed = localStorage.getItem('ios-guide-dismissed');
    
    if (iosGuide && (!dismissed || Date.now() - parseInt(dismissed) > 86400000)) {
        iosGuide.style.display = 'flex';
    }
}

function dismissIOSGuide() {
    const iosGuide = document.getElementById('ios-install-guide');
    if (iosGuide) {
        iosGuide.style.display = 'none';
    }
    localStorage.setItem('ios-guide-dismissed', Date.now());
}
</script>

<!--
========================================
å®‰è£æç¤ºæ©«å¹… HTMLï¼ˆåŠ å…¥é é¢é©ç•¶ä½ç½®ï¼‰
========================================
-->

<style>
/* PWA å®‰è£æ©«å¹…æ¨£å¼ */
.pwa-install-banner {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #1a1f2e 0%, #0d1117 100%);
    padding: 1rem;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    z-index: 9999;
    border-top: 1px solid rgba(184, 115, 51, 0.3);
    box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
}

.pwa-install-banner .content {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.pwa-install-banner .icon {
    font-size: 2rem;
}

.pwa-install-banner .text h4 {
    color: #D4956A;
    margin: 0 0 0.25rem 0;
    font-size: 1rem;
}

.pwa-install-banner .text p {
    color: rgba(255,255,255,0.7);
    margin: 0;
    font-size: 0.85rem;
}

.pwa-install-banner .actions {
    display: flex;
    gap: 0.5rem;
}

.pwa-install-banner .install-btn {
    background: linear-gradient(135deg, #B87333, #D4956A);
    color: white;
    border: none;
    padding: 0.6rem 1.2rem;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.9rem;
    white-space: nowrap;
}

.pwa-install-banner .dismiss-btn {
    background: transparent;
    color: rgba(255,255,255,0.5);
    border: 1px solid rgba(255,255,255,0.2);
    padding: 0.6rem 1rem;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.9rem;
}

/* iOS å®‰è£æŒ‡å— */
.ios-install-guide {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #1a1f2e 0%, #0d1117 100%);
    padding: 1.5rem;
    flex-direction: column;
    gap: 1rem;
    z-index: 9999;
    border-top: 1px solid rgba(184, 115, 51, 0.3);
    box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
}

.ios-install-guide h4 {
    color: #D4956A;
    margin: 0;
    text-align: center;
}

.ios-install-guide .steps {
    display: flex;
    justify-content: center;
    gap: 2rem;
    color: rgba(255,255,255,0.8);
    font-size: 0.9rem;
}

.ios-install-guide .step {
    text-align: center;
}

.ios-install-guide .step-icon {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

.ios-install-guide .close-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: transparent;
    border: none;
    color: rgba(255,255,255,0.5);
    font-size: 1.5rem;
    cursor: pointer;
}

@media (max-width: 480px) {
    .pwa-install-banner {
        flex-direction: column;
        text-align: center;
    }
    
    .pwa-install-banner .content {
        flex-direction: column;
    }
}
</style>

<!-- PWA å®‰è£æ©«å¹…ï¼ˆAndroid / Desktopï¼‰-->
<div id="pwa-install-banner" class="pwa-install-banner">
    <div class="content">
        <span class="icon">ğŸŒ™</span>
        <div class="text">
            <h4>å®‰è£ç™‚ç™’å­¸é™¢ App</h4>
            <p>éš¨æ™‚éš¨åœ°é€²è¡Œå¿ƒéˆç™‚ç™’</p>
        </div>
    </div>
    <div class="actions">
        <button class="install-btn" onclick="installPWA()">å®‰è£</button>
        <button class="dismiss-btn" onclick="dismissInstallBanner()">ç¨å¾Œ</button>
    </div>
</div>

<!-- iOS å®‰è£æŒ‡å— -->
<div id="ios-install-guide" class="ios-install-guide">
    <button class="close-btn" onclick="dismissIOSGuide()">Ã—</button>
    <h4>å°‡ç™‚ç™’å­¸é™¢åŠ å…¥ä¸»ç•«é¢</h4>
    <div class="steps">
        <div class="step">
            <div class="step-icon">ğŸ“¤</div>
            <div>é»æ“Šã€Œåˆ†äº«ã€</div>
        </div>
        <div class="step">
            <div class="step-icon">â•</div>
            <div>åŠ å…¥ä¸»ç•«é¢</div>
        </div>
        <div class="step">
            <div class="step-icon">âœ…</div>
            <div>å®Œæˆï¼</div>
        </div>
    </div>
</div>
