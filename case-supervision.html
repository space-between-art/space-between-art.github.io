<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹æ¡ˆç£å°å®¤ | å¿ƒéˆç™‚ç™’å­¸é™¢ | Space Between Art</title>
    <meta name="description" content="æ•˜äº‹å°å¸«å¸¶é ˜çš„å°ˆæ¥­å€‹æ¡ˆç ”è¨åŸå‹ï¼Œæ·±å…¥å­¸ç¿’å¿ƒç†å­¸æ¦‚å¿µèˆ‡è«®å•†æŠ€å·§">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;500;600&family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --cream: #FDF8F3;
            --cream-dark: #F5EDE4;
            --text-dark: #2A2A2A;
            --text-muted: #6B6B6B;
            --forest: #2C5F2D;
            --forest-dark: #1A3A1B;
            --gold: #D4A84B;
            --steel: #2C3E50;
            --copper: #B87333;
            --purple: #6B5B95;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--cream);
            color: var(--text-dark);
            line-height: 1.7;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--steel) 0%, var(--forest-dark) 100%);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-family: 'Noto Serif TC', serif;
            font-size: 1.3rem;
            font-weight: 500;
        }

        .header-nav a {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            margin-left: 1rem;
            font-size: 0.85rem;
            transition: color 0.3s;
        }

        .header-nav a:hover {
            color: white;
        }

        /* Safety Notice */
        .safety-notice {
            max-width: 100%;
            margin: 0;
            padding: 12px 1.5rem;
            background: rgba(212, 168, 75, 0.15);
            border-bottom: 1px solid rgba(212, 168, 75, 0.3);
            font-size: 0.8rem;
            line-height: 1.6;
            text-align: center;
        }

        .safety-notice strong {
            color: var(--steel);
        }

        /* Mobile Selection Bar */
        .mobile-selection-bar {
            display: none;
            background: white;
            padding: 0.8rem 1rem;
            border-bottom: 1px solid var(--cream-dark);
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .mobile-select-btn {
            flex: 1;
            min-width: 140px;
            padding: 0.7rem 1rem;
            border: 1px solid var(--cream-dark);
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .mobile-select-btn:active {
            background: var(--cream);
        }

        .mobile-select-btn .btn-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .mobile-select-btn .btn-value {
            font-weight: 500;
            color: var(--forest);
        }

        /* Mobile Modal */
        .mobile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: flex-end;
        }

        .mobile-modal.active {
            display: flex;
        }

        .mobile-modal-content {
            background: white;
            width: 100%;
            max-height: 70vh;
            border-radius: 20px 20px 0 0;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .mobile-modal-header {
            padding: 1rem;
            border-bottom: 1px solid var(--cream-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
        }

        .mobile-modal-header h3 {
            font-size: 1.1rem;
            font-family: 'Noto Serif TC', serif;
        }

        .mobile-modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--cream);
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .mobile-modal-body {
            padding: 1rem;
            overflow-y: auto;
            max-height: calc(70vh - 60px);
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 300px 1fr 280px;
            min-height: calc(100vh - 60px);
        }

        /* Left Panel - Case Selection */
        .left-panel {
            background: white;
            border-right: 1px solid var(--cream-dark);
            padding: 1.5rem;
            overflow-y: auto;
        }

        .panel-title {
            font-family: 'Noto Serif TC', serif;
            font-size: 1.1rem;
            color: var(--steel);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--gold);
        }

        /* Case Cards */
        .case-card {
            background: var(--cream);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .case-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .case-card.selected {
            border-color: var(--forest);
            background: rgba(44, 95, 45, 0.05);
        }

        .case-tag {
            display: inline-block;
            font-size: 0.7rem;
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            margin-bottom: 0.5rem;
        }

        .case-tag.pharmacist {
            background: var(--forest);
            color: white;
        }

        .case-tag.renovator {
            background: var(--steel);
            color: white;
        }

        .case-name {
            font-weight: 500;
            margin-bottom: 0.3rem;
        }

        .case-summary {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .case-concepts {
            margin-top: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
        }

        .concept-tag {
            font-size: 0.7rem;
            background: var(--cream-dark);
            padding: 0.15rem 0.5rem;
            border-radius: 8px;
            color: var(--text-muted);
        }

        /* Center Panel - Chat */
        .center-panel {
            display: flex;
            flex-direction: column;
            background: var(--cream);
        }

        /* Mode Selection */
        .mode-bar {
            background: white;
            padding: 0.8rem 1rem;
            border-bottom: 1px solid var(--cream-dark);
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            overflow-x: auto;
        }

        .mode-btn {
            padding: 0.5rem 0.8rem;
            border: 1px solid var(--cream-dark);
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            white-space: nowrap;
        }

        .mode-btn:hover {
            border-color: var(--forest);
        }

        .mode-btn.active {
            background: var(--forest);
            color: white;
            border-color: var(--forest);
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            max-width: 90%;
            padding: 1rem;
            border-radius: 16px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            background: var(--forest);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.assistant {
            background: white;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .message-content {
            line-height: 1.8;
        }

        /* Input Area */
        .input-area {
            background: white;
            padding: 1rem;
            border-top: 1px solid var(--cream-dark);
        }

        .input-container {
            display: flex;
            gap: 0.8rem;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .chat-input {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--cream-dark);
            border-radius: 12px;
            font-size: 0.95rem;
            font-family: inherit;
            resize: none;
            min-height: 46px;
            max-height: 120px;
            transition: border-color 0.3s;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--forest);
        }

        .send-btn {
            padding: 0.8rem 1.2rem;
            background: var(--forest);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .send-btn:hover {
            background: var(--forest-dark);
        }

        .send-btn:disabled {
            background: var(--cream-dark);
            cursor: not-allowed;
        }

        /* Right Panel - Supervisor & Case Info */
        .right-panel {
            background: white;
            border-left: 1px solid var(--cream-dark);
            padding: 1.5rem;
            overflow-y: auto;
        }

        /* Supervisor Selection */
        .supervisor-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }

        .supervisor-card {
            padding: 0.8rem;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            border: 2px solid var(--cream-dark);
        }

        .supervisor-card:hover {
            border-color: var(--gold);
        }

        .supervisor-card.selected {
            border-color: var(--forest);
            background: rgba(44, 95, 45, 0.05);
        }

        .supervisor-avatar {
            font-size: 2rem;
            margin-bottom: 0.3rem;
        }

        .supervisor-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .supervisor-role {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* Case Details */
        .case-details {
            background: var(--cream);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .case-details h4 {
            font-size: 0.9rem;
            margin-bottom: 0.8rem;
            color: var(--steel);
        }

        .case-info-item {
            margin-bottom: 0.8rem;
        }

        .case-info-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.2rem;
        }

        .case-info-value {
            font-size: 0.85rem;
        }

        /* Tips Box */
        .tips-box {
            background: linear-gradient(135deg, var(--gold) 0%, var(--copper) 100%);
            color: white;
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .tips-box h4 {
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .tips-box p {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        /* Loading */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 1rem;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--forest);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Disclaimer */
        .disclaimer {
            background: #FFF3CD;
            border: 1px solid #FFEAA7;
            border-radius: 8px;
            padding: 0.8rem;
            margin-bottom: 1rem;
            font-size: 0.8rem;
        }

        /* Insight Button */
        .insight-btn {
            width: 100%;
            padding: 0.8rem;
            background: linear-gradient(135deg, var(--gold) 0%, var(--copper) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        .insight-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(212, 168, 75, 0.3);
        }
        .insight-btn:disabled {
            background: var(--cream-dark);
            cursor: not-allowed;
            transform: none;
        }
        .insight-content {
            background: var(--cream);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }
        .save-insight-btn {
            width: 100%;
            padding: 0.6rem;
            background: var(--forest);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        .save-insight-btn:hover {
            background: var(--forest-dark);
        }

        /* Footer */
        .site-footer {
            background: var(--text-dark);
            color: white;
            padding: 2rem 1.5rem;
            text-align: center;
        }

        .footer-content-lab {
            max-width: 700px;
            margin: 0 auto 1rem;
            padding: 14px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            font-size: 0.75rem;
            line-height: 1.6;
        }

        .footer-content-lab strong {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--gold);
        }

        .footer-copyright {
            font-size: 0.8rem;
            opacity: 0.5;
        }

        /* Responsive - Tablet */
        @media (max-width: 1100px) {
            .main-container {
                grid-template-columns: 260px 1fr;
            }
            .right-panel {
                display: none;
            }
            .mobile-selection-bar {
                display: flex;
            }
        }

        /* Responsive - Mobile */
        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
            }
            .left-panel {
                display: none;
            }
            .header h1 {
                font-size: 1.1rem;
            }
            .header-nav a {
                font-size: 0.8rem;
                margin-left: 0.8rem;
            }
            .mode-bar {
                padding: 0.6rem 0.8rem;
            }
            .mode-btn {
                padding: 0.4rem 0.7rem;
                font-size: 0.75rem;
            }
            .chat-area {
                padding: 0.8rem;
                min-height: 300px;
            }
            .message {
                max-width: 95%;
                padding: 0.8rem;
            }
            .input-area {
                padding: 0.8rem;
            }
            .chat-input {
                padding: 0.7rem 0.8rem;
                font-size: 0.9rem;
            }
            .send-btn {
                padding: 0.7rem 1rem;
                font-size: 0.85rem;
            }
            .safety-notice {
                padding: 10px 1rem;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>ğŸ“ å€‹æ¡ˆç£å°å®¤</h1>
        <nav class="header-nav">
            <a href="academy.html">è¿”å›å­¸é™¢</a>
            <a href="index.html">é¦–é </a>
        </nav>
    </header>

    <!-- Safety Notice -->
    <div class="safety-notice">
        <strong>é‡è¦è²æ˜ï½œNotice</strong><br>
        æœ¬é äº’å‹•å±¬æ–¼å°èªªè§’è‰²æ•˜äº‹å°è©±åŸå‹å±•ç¤ºï¼Œç”¨æ–¼å…§å®¹å¯¦é©—èˆ‡æ•™è‚²é«”é©—ã€‚æœ¬é ä¸æ§‹æˆä»»ä½•å·²éƒ¨ç½²çš„å¿ƒç†è«®è©¢æœå‹™ã€AI ç³»çµ±ã€SaaS å¹³å°æˆ–å•†æ¥­åŒ–ç”¢å“ã€‚
    </div>

    <!-- Mobile Selection Bar -->
    <div class="mobile-selection-bar">
        <button class="mobile-select-btn" onclick="openModal('case')">
            <div>
                <div class="btn-label">ğŸ“‹ æ¡ˆä¾‹</div>
                <div class="btn-value" id="selected-case-display">è«‹é¸æ“‡</div>
            </div>
            <span>â–¼</span>
        </button>
        <button class="mobile-select-btn" onclick="openModal('supervisor')">
            <div>
                <div class="btn-label">ğŸ‘¤ ç£å°</div>
                <div class="btn-value" id="selected-supervisor-display">ğŸ’œ é¡§æ›¼</div>
            </div>
            <span>â–¼</span>
        </button>
    </div>

    <!-- Mobile Case Modal -->
    <div class="mobile-modal" id="case-modal">
        <div class="mobile-modal-content">
            <div class="mobile-modal-header">
                <h3>ğŸ“‹ é¸æ“‡æ¡ˆä¾‹</h3>
                <button class="mobile-modal-close" onclick="closeModal('case')">âœ•</button>
            </div>
            <div class="mobile-modal-body">
                <div class="disclaimer">
                    âš ï¸ æœ¬é ä½¿ç”¨è™›æ§‹æ¡ˆä¾‹é€²è¡Œæ•™å­¸å±•ç¤ºï¼Œä¸æä¾›çœŸå¯¦å€‹æ¡ˆç£å°æœå‹™ï¼Œäº¦éå·²ä¸Šç·šçš„è«®è©¢ç³»çµ±ã€‚
                </div>
                <div id="mobile-case-list"></div>
            </div>
        </div>
    </div>

    <!-- Mobile Supervisor Modal -->
    <div class="mobile-modal" id="supervisor-modal">
        <div class="mobile-modal-content">
            <div class="mobile-modal-header">
                <h3>ğŸ‘¤ é¸æ“‡ç£å°</h3>
                <button class="mobile-modal-close" onclick="closeModal('supervisor')">âœ•</button>
            </div>
            <div class="mobile-modal-body">
                <div class="supervisor-grid" id="mobile-supervisor-grid">
                    <div class="supervisor-card selected" data-supervisor="guman" onclick="selectSupervisorMobile('guman')">
                        <div class="supervisor-avatar">ğŸ’œ</div>
                        <div class="supervisor-name">é¡§æ›¼</div>
                        <div class="supervisor-role">å¿ƒç†å‹•åŠ›</div>
                    </div>
                    <div class="supervisor-card" data-supervisor="luyao" onclick="selectSupervisorMobile('luyao')">
                        <div class="supervisor-avatar">ğŸ”§</div>
                        <div class="supervisor-name">è·¯é™</div>
                        <div class="supervisor-role">å¯¦å‹™ä»‹å…¥</div>
                    </div>
                    <div class="supervisor-card" data-supervisor="xi" onclick="selectSupervisorMobile('xi')">
                        <div class="supervisor-avatar">ğŸŒ™</div>
                        <div class="supervisor-name">æ›¦å©†å©†</div>
                        <div class="supervisor-role">ç£å°åæ€</div>
                    </div>
                    <div class="supervisor-card" data-supervisor="qing" onclick="selectSupervisorMobile('qing')">
                        <div class="supervisor-avatar">â˜€ï¸</div>
                        <div class="supervisor-name">æ™´</div>
                        <div class="supervisor-role">ç³»çµ±è§€é»</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <main class="main-container">
        <!-- Left Panel: Case Selection (Desktop) -->
        <aside class="left-panel">
            <h2 class="panel-title">ğŸ“‹ é¸æ“‡æ¡ˆä¾‹</h2>
            
            <div class="disclaimer">
                âš ï¸ æœ¬é ä½¿ç”¨è™›æ§‹æ¡ˆä¾‹é€²è¡Œæ•™å­¸å±•ç¤ºï¼Œä¸æä¾›çœŸå¯¦å€‹æ¡ˆç£å°æœå‹™ï¼Œäº¦éå·²ä¸Šç·šçš„è«®è©¢ç³»çµ±ã€‚
            </div>

            <div id="case-list"></div>
        </aside>

        <!-- Center Panel: Chat -->
        <section class="center-panel">
            <!-- Mode Selection -->
            <div class="mode-bar">
                <button class="mode-btn active" data-mode="socratic" onclick="selectMode('socratic')">
                    ğŸ¤” è˜‡æ ¼æ‹‰åº•æå•
                </button>
                <button class="mode-btn" data-mode="discussion" onclick="selectMode('discussion')">
                    ğŸ“š æ¡ˆä¾‹è¨è«–
                </button>
                <button class="mode-btn" data-mode="roleplay" onclick="selectMode('roleplay')">
                    ğŸ­ è§’è‰²æ‰®æ¼”
                </button>
                <button class="mode-btn" data-mode="reflection" onclick="selectMode('reflection')">
                    ğŸ’­ ç£å°åæ€
                </button>
            </div>

            <!-- Chat Area -->
            <div class="chat-area" id="chat-area">
                <div class="message assistant">
                    <div class="message-header">
                        <span>ğŸ’œ é¡§æ›¼ç£å°</span>
                    </div>
                    <div class="message-content">
                        æ­¡è¿ä¾†åˆ°å€‹æ¡ˆç£å°å®¤ã€‚è«‹å…ˆé¸æ“‡ä¸€å€‹æ¡ˆä¾‹ï¼Œç„¶å¾Œæˆ‘å€‘å¯ä»¥é–‹å§‹è¨è«–ã€‚
                        <br><br>
                        ä½ å¯ä»¥é¸æ“‡ä¸åŒçš„äº’å‹•æ¨¡å¼ï¼š
                        <br>â€¢ <strong>è˜‡æ ¼æ‹‰åº•æå•</strong>ï¼šæˆ‘æœƒç”¨å•é¡Œå¼•å°ä½ æ€è€ƒ
                        <br>â€¢ <strong>æ¡ˆä¾‹è¨è«–</strong>ï¼šåƒçœŸå¯¦ç£å°æœƒè­°ä¸€æ¨£ç ”è¨æ¡ˆä¾‹
                        <br>â€¢ <strong>è§’è‰²æ‰®æ¼”</strong>ï¼šæˆ‘æœƒæ‰®æ¼”æ¡ˆä¸»ï¼Œè®“ä½ ç·´ç¿’è«®å•†æŠ€å·§
                        <br>â€¢ <strong>ç£å°åæ€</strong>ï¼šæ¢ç´¢ä½ åœ¨åŠ©äººéç¨‹ä¸­çš„å…§åœ¨åæ‡‰
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-area">
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea 
                            class="chat-input" 
                            id="chat-input" 
                            placeholder="è¼¸å…¥ä½ çš„æƒ³æ³•ã€å•é¡Œæˆ–å›æ‡‰..."
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                        ></textarea>
                    </div>
                    <button class="send-btn" id="send-btn" onclick="sendMessage()">
                        ç™¼é€ â¤
                    </button>
                </div>
            </div>
        </section>

        <!-- Right Panel: Supervisor & Info (Desktop) -->
        <aside class="right-panel">
            <h3 class="panel-title">ğŸ‘¤ é¸æ“‡ç£å°</h3>
            
            <div class="supervisor-grid">
                <div class="supervisor-card selected" data-supervisor="guman" onclick="selectSupervisor('guman')">
                    <div class="supervisor-avatar">ğŸ’œ</div>
                    <div class="supervisor-name">é¡§æ›¼</div>
                    <div class="supervisor-role">å¿ƒç†å‹•åŠ›</div>
                </div>
                <div class="supervisor-card" data-supervisor="luyao" onclick="selectSupervisor('luyao')">
                    <div class="supervisor-avatar">ğŸ”§</div>
                    <div class="supervisor-name">è·¯é™</div>
                    <div class="supervisor-role">å¯¦å‹™ä»‹å…¥</div>
                </div>
                <div class="supervisor-card" data-supervisor="xi" onclick="selectSupervisor('xi')">
                    <div class="supervisor-avatar">ğŸŒ™</div>
                    <div class="supervisor-name">æ›¦å©†å©†</div>
                    <div class="supervisor-role">ç£å°åæ€</div>
                </div>
                <div class="supervisor-card" data-supervisor="qing" onclick="selectSupervisor('qing')">
                    <div class="supervisor-avatar">â˜€ï¸</div>
                    <div class="supervisor-name">æ™´</div>
                    <div class="supervisor-role">ç³»çµ±è§€é»</div>
                </div>
            </div>

            <div class="case-details" id="case-details">
                <h4>ğŸ“„ æ¡ˆä¾‹è³‡è¨Š</h4>
                <p style="color: var(--text-muted); font-size: 0.85rem;">è«‹å…ˆé¸æ“‡ä¸€å€‹æ¡ˆä¾‹</p>
            </div>

            <div class="tips-box" id="tips-box">
                <h4>ğŸ’¡ æœ¬æ¨¡å¼æç¤º</h4>
                <p>è˜‡æ ¼æ‹‰åº•æå•æ¨¡å¼ï¼šç£å°æœƒç”¨å•é¡Œå¼•å°ä½ æ·±å…¥æ€è€ƒï¼Œä¸æœƒç›´æ¥çµ¦ç­”æ¡ˆã€‚è©¦è‘—å®Œæ•´è¡¨é”ä½ çš„è§€å¯Ÿå’Œå‡è¨­ã€‚</p>
            </div>
        </aside>
    </main>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="footer-content-lab">
            <strong>Content Lab Notice</strong>
            Space Between Art is an original narrative content laboratory presenting storyworld exploration and creative IP prototypes.
            This site does not represent any deployed SaaS platform, AI service system, subscription product, or launched commercial software.
        </div>
        <p class="footer-copyright">Â© 2025 éš™å…‰å‰µä½œ Space Between Art. All rights reserved.</p>
    </footer>

    <script>
        // ========== æ¡ˆä¾‹è³‡æ–™åº« ==========
        const caseDatabase = {
            p01: {
                name: "é˜¿å§¨çš„æ¯èå¿ƒå…‰",
                source: "é€å…‰çš„è—¥å¸«",
                client: "é™³é˜¿å§¨ï¼Œ68æ­²å¥³æ€§",
                presenting: "ç¨å±…ã€ç¤¾äº¤é€€ç¸®ã€é£Ÿæ…¾ä¸‹é™ã€å¤±çœ ã€å°ç”Ÿæ´»å¤±å»èˆˆè¶£",
                background: "ä¸ˆå¤«ä¸‰å¹´å‰éä¸–ï¼Œå”¯ä¸€çš„å…’å­åœ¨åœ‹å¤–å·¥ä½œï¼Œé„°å±…åæ˜ å¥¹å·²ç¶“å¾ˆå°‘å‡ºé–€ã€‚æ›œçœ‹è¦‹å¥¹çš„å¿ƒå…‰å‘ˆç¾æ¯é»ƒè‰²ï¼Œåƒæ˜¯ä¹¾æ¯çš„è‘‰å­ã€‚",
                concepts: ["å“€å‚·è¼”å°", "ä¾é™„ç†è«–", "è€å¹´å¿ƒç†", "ç¤¾æœƒå­¤ç«‹"],
                questions: ["ä½ å¦‚ä½•æ¦‚å¿µåŒ–é™³é˜¿å§¨ç›®å‰çš„ç‹€æ…‹ï¼Ÿ", "è¤‡é›œæ€§å“€å‚·å’Œæ­£å¸¸å“€å‚·çš„å€åˆ¥æ˜¯ä»€éº¼ï¼Ÿ", "ä½ æœƒå¦‚ä½•å»ºç«‹èˆ‡é™³é˜¿å§¨çš„æ²»ç™‚é—œä¿‚ï¼Ÿ"]
            },
            p02: {
                name: "å°å¤çš„é»‘è‰²å¿ƒå…‰",
                source: "é€å…‰çš„è—¥å¸«",
                client: "å°å¤ï¼Œ16æ­²å¥³é«˜ä¸­ç”Ÿ",
                presenting: "æ‰‹è‡‚æœ‰è‡ªå‚·ç—•è·¡ã€æˆç¸¾ä¸‹æ»‘ã€èˆ‡å®¶äººè¡çªé »ç¹ã€ç¤¾äº¤é€€ç¸®",
                background: "çˆ¶æ¯å°å¥¹çš„æœŸæœ›å¾ˆé«˜ï¼Œå¥¹è¦ºå¾—è‡ªå·±æ°¸é é”ä¸åˆ°æ¨™æº–ã€‚æ›œçœ‹è¦‹å¥¹çš„å¿ƒå…‰ä¸­å¤®æœ‰ä¸€åœ˜é»‘è‰²çš„æ¼©æ¸¦ï¼Œä½†é‚Šç·£ä»æœ‰å¾®å¼±çš„å…‰ã€‚",
                concepts: ["é’å°‘å¹´ç™¼å±•", "è‡ªå‚·è¡Œç‚º", "å®¶åº­å‹•åŠ›", "å±æ©Ÿè©•ä¼°"],
                questions: ["ä½ æœƒå¦‚ä½•é€²è¡Œè‡ªæ®º/è‡ªå‚·çš„é¢¨éšªè©•ä¼°ï¼Ÿ", "è‡ªå‚·è¡Œç‚ºçš„åŠŸèƒ½å¯èƒ½æ˜¯ä»€éº¼ï¼Ÿ", "å¦‚ä½•èˆ‡å°å¤çš„çˆ¶æ¯å·¥ä½œï¼Ÿ"]
            },
            p03: {
                name: "é™³è€å¸«çš„é–ƒçˆå…‰èŠ’",
                source: "é€å…‰çš„è—¥å¸«",
                client: "é™³è€å¸«ï¼Œ35æ­²åœ‹å°è€å¸«",
                presenting: "é•·æœŸç–²æ†Šã€å°å·¥ä½œå¤±å»ç†±æƒ…ã€å®¹æ˜“ç…©èºã€ç¡çœ å“è³ªå·®",
                background: "æ•™æ›¸10å¹´ï¼Œä¸€ç›´æ˜¯å­¸æ ¡çš„æ¨¡ç¯„æ•™å¸«ï¼Œä½†æœ€è¿‘é–‹å§‹æ‡·ç–‘è‡ªå·±çš„åƒ¹å€¼ã€‚æ›œçœ‹è¦‹å¥¹çš„å¿ƒå…‰ä¸æ–·é–ƒçˆï¼Œåƒæ˜¯å¿«è¦ç†„æ»…çš„ç‡ˆæ³¡ã€‚",
                concepts: ["è·æ¥­å€¦æ€ ", "å®Œç¾ä¸»ç¾©", "è‡ªæˆ‘åƒ¹å€¼", "ç•Œé™è¨­å®š"],
                questions: ["è·æ¥­å€¦æ€ çš„ä¸‰å€‹æ ¸å¿ƒç—‡ç‹€æ˜¯ä»€éº¼ï¼Ÿ", "å®Œç¾ä¸»ç¾©å¦‚ä½•å½±éŸ¿é™³è€å¸«çš„ç‹€æ…‹ï¼Ÿ", "ä½ æœƒå»ºè­°ä»€éº¼æ¨£çš„è‡ªæˆ‘ç…§é¡§ç­–ç•¥ï¼Ÿ"]
            },
            r01: {
                name: "ç»ç’ƒå±‹çš„å¥³å­©",
                source: "é•ç« éˆé­‚æ”¹å»ºäº‹å‹™æ‰€",
                client: "å°çªï¼Œ28æ­²ä¸Šç­æ—",
                presenting: "äººéš›é—œä¿‚ä¸ç©©å®šã€æƒ…ç·’èµ·ä¼å¤§ã€å®³æ€•è¢«æ‹‹æ£„ã€å¸¸æ„Ÿç©ºè™›",
                background: "è·¯é™çœ‹è¦‹å¥¹çš„å¿ƒéˆå»ºç¯‰æ˜¯ä¸€åº§é€æ˜çš„ç»ç’ƒå±‹â€”â€”æ²’æœ‰éš±ç§ï¼Œæ‰€æœ‰æƒ…ç·’éƒ½æš´éœ²åœ¨å¤–ã€‚å¥¹å°åˆ¥äººçš„æƒ…ç·’æ¥µåº¦æ•æ„Ÿï¼Œå»ç„¡æ³•ä¿è­·è‡ªå·±ã€‚",
                concepts: ["é‚Šç·£å‹äººæ ¼ç‰¹è³ª", "æƒ…ç·’èª¿ç¯€", "ä¾é™„å‰µå‚·", "ç•Œé™è­°é¡Œ"],
                questions: ["ç»ç’ƒå±‹çš„å»ºç¯‰éš±å–»ä»£è¡¨ä»€éº¼å¿ƒç†ç‹€æ…‹ï¼Ÿ", "ä½ æœƒå¦‚ä½•èˆ‡é€™æ¨£çš„æ¡ˆä¸»å»ºç«‹æ²»ç™‚åŒç›Ÿï¼Ÿ", "DBTä¸­çš„æƒ…ç·’èª¿ç¯€æŠ€å·§æœ‰å“ªäº›ï¼Ÿ"]
            },
            r02: {
                name: "æ²’æœ‰é–€çš„ç¢‰å ¡",
                source: "é•ç« éˆé­‚æ”¹å»ºäº‹å‹™æ‰€",
                client: "é˜¿å‡±ï¼Œ40æ­²å·¥ç¨‹å¸«",
                presenting: "è¦ªå¯†é—œä¿‚å›°é›£ã€æƒ…æ„Ÿç–é›¢ã€å·¥ä½œè¡¨ç¾å„ªç•°ä½†äººéš›å†·æ¼ ",
                background: "è·¯é™çœ‹è¦‹ä»–çš„å¿ƒéˆå»ºç¯‰æ˜¯ä¸€åº§æ²’æœ‰é–€çª—çš„ç¢‰å ¡â€”â€”å …å›ºä½†å®Œå…¨å°é–‰ã€‚ç«¥å¹´æ™‚çˆ¶è¦ªé…—é…’ï¼Œä»–å­¸æœƒäº†ä¸è®“ä»»ä½•äººé è¿‘ã€‚",
                concepts: ["è¿´é¿å‹ä¾é™„", "æƒ…æ„Ÿéš”é›¢", "ç«¥å¹´å‰µå‚·", "é˜²è¡›æ©Ÿåˆ¶"],
                questions: ["ç¢‰å ¡çš„é˜²è¡›åŠŸèƒ½æ˜¯ä»€éº¼ï¼Ÿå®ƒä¿è­·äº†ä»€éº¼ï¼Ÿ", "å¦‚ä½•èˆ‡é«˜åº¦é˜²è¡›çš„æ¡ˆä¸»å·¥ä½œï¼Ÿ", "è¿´é¿å‹ä¾é™„çš„æˆå› å’Œè¡¨ç¾æ˜¯ä»€éº¼ï¼Ÿ"]
            },
            r03: {
                name: "ç„¡é™æ¨“æ¢¯çš„ç”·äºº",
                source: "é•ç« éˆé­‚æ”¹å»ºäº‹å‹™æ‰€",
                client: "å¿—æ˜ï¼Œ32æ­²æœƒè¨ˆå¸«",
                presenting: "åè¦†æª¢æŸ¥ã€ä¾µå…¥æ€§æ€ç·’ã€é«˜åº¦ç„¦æ…®ã€ç¡å‰å„€å¼è€—æ™‚",
                background: "è·¯é™çœ‹è¦‹ä»–çš„å¿ƒéˆå»ºç¯‰æ˜¯ä¸€æ£Ÿæœ‰ç„¡é™æ¨“æ¢¯çš„å¤§æ¨“â€”â€”ä¸ç®¡æ€éº¼èµ°éƒ½åˆ°ä¸äº†ç›®çš„åœ°ï¼Œæ°¸é åœ¨é‡è¤‡åŒæ¨£çš„è·¯ã€‚",
                concepts: ["å¼·è¿«ç—‡", "ç„¦æ…®ç–¾æ‚£", "èªçŸ¥è¡Œç‚ºæ²»ç™‚", "æš´éœ²èˆ‡åæ‡‰é é˜²"],
                questions: ["ç„¡é™æ¨“æ¢¯ä»£è¡¨ä»€éº¼æ¨£çš„å¿ƒç†å›°å¢ƒï¼Ÿ", "å¼·è¿«ç—‡çš„èªçŸ¥æ¨¡å‹æ˜¯ä»€éº¼ï¼Ÿ", "ERPæ²»ç™‚çš„åŸç†å’Œæ­¥é©Ÿæ˜¯ä»€éº¼ï¼Ÿ"]
            },
            r04: {
                name: "è£‚ç¸«ä¸­çš„å…‰",
                source: "é•ç« éˆé­‚æ”¹å»ºäº‹å‹™æ‰€",
                client: "ç¾ç²ï¼Œ45æ­²ä¹³ç™Œå€–å­˜è€…",
                presenting: "ç¶“æ­·é‡å¤§ç–¾ç—…å¾Œçš„æ„ç¾©è¿½å°‹ã€èº«ä»½èªåŒé‡å»ºã€å‰µå‚·å¾Œæˆé•·",
                background: "è·¯é™çœ‹è¦‹å¥¹çš„å¿ƒéˆå»ºç¯‰æœ‰è¨±å¤šè£‚ç¸«ï¼Œä½†è£‚ç¸«ä¸­é€å‡ºé‡‘è‰²çš„å…‰â€”â€”å°±åƒé‡‘ç¹•ä¿®å¾©çš„é™¶å™¨ï¼Œå‚·ç—•æˆç‚ºäº†ç¾éº—çš„ä¸€éƒ¨åˆ†ã€‚",
                concepts: ["å‰µå‚·å¾Œæˆé•·", "å¾©åŸåŠ›", "æ„ç¾©æ²»ç™‚", "å­˜åœ¨ä¸»ç¾©"],
                questions: ["å‰µå‚·å¾Œæˆé•·çš„äº”å€‹é¢å‘æ˜¯ä»€éº¼ï¼Ÿ", "å¦‚ä½•ä¿ƒé€²æ¡ˆä¸»çš„æ„ç¾©å»ºæ§‹ï¼Ÿ", "é‡‘ç¹•ä¿®å¾©çš„éš±å–»å¦‚ä½•æ‡‰ç”¨åœ¨æ²»ç™‚ä¸­ï¼Ÿ"]
            }
        };

        // ========== æ¨¡å¼æç¤º ==========
        const modeTips = {
            socratic: "è˜‡æ ¼æ‹‰åº•æå•æ¨¡å¼ï¼šç£å°æœƒç”¨å•é¡Œå¼•å°ä½ æ·±å…¥æ€è€ƒï¼Œä¸æœƒç›´æ¥çµ¦ç­”æ¡ˆã€‚è©¦è‘—å®Œæ•´è¡¨é”ä½ çš„è§€å¯Ÿå’Œå‡è¨­ã€‚",
            discussion: "æ¡ˆä¾‹è¨è«–æ¨¡å¼ï¼šåƒçœŸå¯¦ç£å°æœƒè­°ä¸€æ¨£ç ”è¨æ¡ˆä¾‹ã€‚ä½ å¯ä»¥æå‡ºä½ çš„æ¦‚å¿µåŒ–ã€æ²»ç™‚è¨ˆç•«ã€æˆ–ä»»ä½•ç–‘å•ã€‚",
            roleplay: "è§’è‰²æ‰®æ¼”æ¨¡å¼ï¼šç£å°æœƒæ‰®æ¼”æ¡ˆä¸»ï¼Œè®“ä½ ç·´ç¿’è«®å•†æŠ€å·§ã€‚èªªã€Œæš«åœã€å¯ä»¥è·³å‡ºè§’è‰²ç²å¾—å›é¥‹ã€‚",
            reflection: "ç£å°åæ€æ¨¡å¼ï¼šæ¢ç´¢ä½ åœ¨åŠ©äººéç¨‹ä¸­çš„å…§åœ¨åæ‡‰ã€‚é€™æ˜¯ä¸€å€‹å®‰å…¨çš„ç©ºé–“ï¼Œå¯ä»¥è«‡è«‡æ¡ˆä¾‹å°ä½ çš„å½±éŸ¿ã€‚"
        };

        // ========== ç‹€æ…‹ç®¡ç† ==========
        let currentCase = null;
        let currentSupervisor = 'guman';
        let currentMode = 'socratic';
        let conversationHistory = [];
        let isLoading = false;

        const supervisorNames = {
            guman: { name: 'é¡§æ›¼', emoji: 'ğŸ’œ' },
            luyao: { name: 'è·¯é™', emoji: 'ğŸ”§' },
            xi: { name: 'æ›¦å©†å©†', emoji: 'ğŸŒ™' },
            qing: { name: 'æ™´', emoji: 'â˜€ï¸' }
        };

        // ========== åˆå§‹åŒ–æ¡ˆä¾‹åˆ—è¡¨ ==========
        function initCaseLists() {
            const caseListHTML = Object.keys(caseDatabase).map(caseId => {
                const caseData = caseDatabase[caseId];
                const tagClass = caseId.startsWith('p') ? 'pharmacist' : 'renovator';
                return `
                    <div class="case-card" data-case="${caseId}" onclick="selectCase('${caseId}')">
                        <span class="case-tag ${tagClass}">${caseData.source}</span>
                        <div class="case-name">${caseData.name}</div>
                        <div class="case-summary">${caseData.presenting.substring(0, 30)}...</div>
                        <div class="case-concepts">
                            ${caseData.concepts.slice(0, 2).map(c => `<span class="concept-tag">${c}</span>`).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('case-list').innerHTML = caseListHTML;
            document.getElementById('mobile-case-list').innerHTML = caseListHTML;
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        initCaseLists();

        // ========== Mobile Modal Functions ==========
        function openModal(type) {
            document.getElementById(`${type}-modal`).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(type) {
            document.getElementById(`${type}-modal`).classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close modal when clicking outside
        document.querySelectorAll('.mobile-modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        });

        // ========== é¸æ“‡åŠŸèƒ½ ==========
        function selectCase(caseId) {
            currentCase = caseId;
            conversationHistory = [];
            
            // æ›´æ–°æ‰€æœ‰ UI
            document.querySelectorAll('.case-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelectorAll(`[data-case="${caseId}"]`).forEach(card => {
                card.classList.add('selected');
            });

            const caseData = caseDatabase[caseId];

            // æ›´æ–° Mobile é¡¯ç¤º
            document.getElementById('selected-case-display').textContent = caseData.name;

            // é¡¯ç¤ºæ¡ˆä¾‹è©³æƒ…
            document.getElementById('case-details').innerHTML = `
                <h4>ğŸ“„ ${caseData.name}</h4>
                <div class="case-info-item">
                    <div class="case-info-label">æ¡ˆä¸»</div>
                    <div class="case-info-value">${caseData.client}</div>
                </div>
                <div class="case-info-item">
                    <div class="case-info-label">ä¸»è¨´</div>
                    <div class="case-info-value">${caseData.presenting}</div>
                </div>
                <div class="case-info-item">
                    <div class="case-info-label">ç›¸é—œæ¦‚å¿µ</div>
                    <div class="case-info-value">${caseData.concepts.join('ã€')}</div>
                </div>
            `;

            // æ¸…ç©ºèŠå¤©å€ä¸¦æ·»åŠ é–‹å ´è¨Šæ¯
            document.getElementById('chat-area').innerHTML = '';
            const supervisor = supervisorNames[currentSupervisor];
            const openingMessage = generateOpeningMessage(caseData);
            addMessage('assistant', openingMessage, supervisor);

            // é—œé–‰ Mobile Modal
            closeModal('case');
        }

        function selectSupervisor(supervisorId) {
            currentSupervisor = supervisorId;
            
            document.querySelectorAll('.right-panel .supervisor-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`.right-panel [data-supervisor="${supervisorId}"]`).classList.add('selected');
            
            // æ›´æ–° Mobile é¡¯ç¤º
            const sup = supervisorNames[supervisorId];
            document.getElementById('selected-supervisor-display').textContent = `${sup.emoji} ${sup.name}`;
        }

        function selectSupervisorMobile(supervisorId) {
            currentSupervisor = supervisorId;
            
            document.querySelectorAll('#mobile-supervisor-grid .supervisor-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`#mobile-supervisor-grid [data-supervisor="${supervisorId}"]`).classList.add('selected');
            
            // ä¹Ÿæ›´æ–°æ¡Œé¢ç‰ˆ
            document.querySelectorAll('.right-panel .supervisor-card').forEach(card => {
                card.classList.remove('selected');
            });
            const desktopCard = document.querySelector(`.right-panel [data-supervisor="${supervisorId}"]`);
            if (desktopCard) desktopCard.classList.add('selected');
            
            // æ›´æ–° Mobile é¡¯ç¤º
            const sup = supervisorNames[supervisorId];
            document.getElementById('selected-supervisor-display').textContent = `${sup.emoji} ${sup.name}`;
            
            closeModal('supervisor');
        }

        function selectMode(mode) {
            currentMode = mode;
            
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');

            document.getElementById('tips-box').innerHTML = `
                <h4>ğŸ’¡ æœ¬æ¨¡å¼æç¤º</h4>
                <p>${modeTips[mode]}</p>
            `;
        }

        // ========== è¨Šæ¯åŠŸèƒ½ ==========
        function generateOpeningMessage(caseData) {
            const modeOpening = {
                socratic: `å¥½ï¼Œè®“æˆ‘å€‘ä¾†çœ‹ã€Œ${caseData.name}ã€é€™å€‹æ¡ˆä¾‹ã€‚\n\næ¡ˆä¸»æ˜¯${caseData.client}ï¼Œ${caseData.presenting}ã€‚\n\nåœ¨æˆ‘å€‘æ·±å…¥è¨è«–ä¹‹å‰ï¼Œæˆ‘æƒ³å…ˆè½è½ä½ çš„åˆæ­¥è§€å¯Ÿï¼šç•¶ä½ è®€åˆ°é€™äº›è³‡æ–™æ™‚ï¼Œä½ æ³¨æ„åˆ°ä»€éº¼ï¼Ÿ`,
                discussion: `æˆ‘å€‘ä»Šå¤©è¦è¨è«–çš„æ˜¯ã€Œ${caseData.name}ã€ã€‚\n\nã€æ¡ˆä¸»èƒŒæ™¯ã€‘\n${caseData.client}\n\nã€ä¸»è¨´å•é¡Œã€‘\n${caseData.presenting}\n\nä½ å¯ä»¥å…ˆåˆ†äº«ä½ å°é€™å€‹æ¡ˆä¾‹çš„åˆæ­¥æ¦‚å¿µåŒ–ã€‚`,
                roleplay: `å¥½çš„ï¼Œæˆ‘å€‘ä¾†ç·´ç¿’ã€Œ${caseData.name}ã€é€™å€‹æ¡ˆä¾‹ã€‚æˆ‘æœƒæ‰®æ¼”æ¡ˆä¸»ï¼Œä½ ä¾†æ‰®æ¼”è«®å•†å¸«ã€‚\n\næº–å‚™å¥½äº†å—ï¼Ÿç•¶ä½ æº–å‚™å¥½ï¼Œå°±é–‹å§‹èªªè©±å§ã€‚å¦‚æœéœ€è¦æš«åœè¨è«–ï¼Œè«‹èªªã€Œæš«åœã€ã€‚\n\n---\n\n*æ¡ˆä¸»èµ°é€²è«®å•†å®¤ï¼Œæœ‰äº›ä¾·ä¿ƒåœ°åä¸‹*`,
                reflection: `æˆ‘å€‘ä»Šå¤©é¸æ“‡äº†ã€Œ${caseData.name}ã€é€™å€‹æ¡ˆä¾‹ä¾†é€²è¡Œåæ€ã€‚\n\nåœ¨é–‹å§‹ä¹‹å‰ï¼Œæˆ‘æƒ³é‚€è«‹ä½ å…ˆéœä¸‹ä¾†ï¼Œæ„Ÿå—ä¸€ä¸‹ï¼šç•¶ä½ è®€åˆ°é€™å€‹æ¡ˆä¾‹çš„æè¿°æ™‚ï¼Œä½ çš„å…§å¿ƒæœ‰ä»€éº¼åæ‡‰ï¼Ÿ`
            };
            return modeOpening[currentMode];
        }

        function addMessage(role, content, supervisor = null) {
            const chatArea = document.getElementById('chat-area');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            if (role === 'assistant' && supervisor) {
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span>${supervisor.emoji} ${supervisor.name}ç£å°</span>
                    </div>
                    <div class="message-content">${content.replace(/\n/g, '<br>')}</div>
                `;
            } else {
                messageDiv.innerHTML = `<div class="message-content">${content.replace(/\n/g, '<br>')}</div>`;
            }
            
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function addTypingIndicator() {
            const chatArea = document.getElementById('chat-area');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            `;
            chatArea.appendChild(typingDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function removeTypingIndicator() {
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
        }

        // ========== ç™¼é€è¨Šæ¯ ==========
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message || isLoading) return;
            
            if (!currentCase) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹æ¡ˆä¾‹');
                return;
            }

            addMessage('user', message);
            input.value = '';
            input.style.height = 'auto';
            
            conversationHistory.push({ role: 'user', content: message });

            isLoading = true;
            document.getElementById('send-btn').disabled = true;
            addTypingIndicator();

            try {
                const caseData = caseDatabase[currentCase];
                const caseContext = `
æ¡ˆä¾‹åç¨±ï¼š${caseData.name}
æ¡ˆä¸»ï¼š${caseData.client}
ä¸»è¨´ï¼š${caseData.presenting}
èƒŒæ™¯ï¼š${caseData.background}
ç›¸é—œå¿ƒç†å­¸æ¦‚å¿µï¼š${caseData.concepts.join('ã€')}
                `.trim();

                const response = await fetch('https://healing-ai-editor.winsusa2611.workers.dev', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        character: currentSupervisor,
                        mode: currentMode,
                        caseId: currentCase,
                        caseContext: caseContext,
                        conversationHistory: conversationHistory.slice(-10)
                    })
                });

                const data = await response.json();
                
                removeTypingIndicator();
                
                if (data.reply) {
                    addMessage('assistant', data.reply, supervisorNames[currentSupervisor]);
                    conversationHistory.push({ role: 'assistant', content: data.reply });
                } else if (data.error) {
                    addMessage('assistant', `æŠ±æ­‰ï¼Œç™¼ç”Ÿäº†éŒ¯èª¤ï¼š${data.error}`, supervisorNames[currentSupervisor]);
                } else {
                    addMessage('assistant', 'æŠ±æ­‰ï¼Œé€£ç·šç™¼ç”Ÿå•é¡Œï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', supervisorNames[currentSupervisor]);
                }

            } catch (error) {
                removeTypingIndicator();
                addMessage('assistant', 'æŠ±æ­‰ï¼Œé€£ç·šç™¼ç”Ÿå•é¡Œï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', supervisorNames[currentSupervisor]);
            }

            isLoading = false;
            document.getElementById('send-btn').disabled = false;
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Auto-resize textarea
        document.getElementById('chat-input').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
    </script>
</body>
</html>
